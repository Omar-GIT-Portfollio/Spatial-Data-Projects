---
title: 'Geometry operations'
author: "Omar Ali"
date: "`r Sys.Date()`"
output: html_document
---
```{r}
library(dplyr)
library(sf)
library(terra)
library(spData)
library(tmap)
```



```{r}
setwd("C:/Users/omarali/R")
```

```{r}
# load the lab data
load("Lab11data.RData") 
class(torn) # sp object
```


```{r}
class(us_states)
```

```{r}
# convert to sf objects
torn_sf <- st_as_sf(torn)
us_states_sf <- st_as_sf(us_states)

# Examine the dataset
summary(torn_sf)
```

```{r}


# Texas AOI
AoI_sf <- us_states_sf %>% filter(STATE_NAME == "Texas")

# work in meters for geometry ops
crs_m  <- 5070
torn_m <- st_transform(torn_sf, crs_m)
AoI_m  <- st_transform(AoI_sf,  crs_m)

```


```{r}
st_geometry(torn_sf) 
```


```{r}
tm_shape(us_states_sf) +
  tm_polygons("grey90") +
  # add the torn points 
  tm_shape(torn_sf) +
    tm_dots(col = "#FB6A4A", size = 0.04, shape = 1, fill_alpha = 0.5) +
  # map the state borders
  tm_shape(us_states_sf) +
    tm_borders(col = "black") +
      tm_layout(frame = F) 
```


```{r}
plot(us_states, col = "grey90")
plot(torn, add = T, pch = 1, col = "#FB6A4A4C", cex = 0.4)
plot(us_states, add = T)
```

```{r}
AoI_sf <- us_states_sf %>% filter(STATE_NAME %in% "Texas" |
                             STATE_NAME %in% "New Mexico" |
                             STATE_NAME %in% "Oklahoma" |
                             STATE_NAME %in% "Arkansas")
tm_shape(AoI_sf) +
  tm_borders(col = "black") +
  tm_layout(frame = F) +
  # add the torn points 
  tm_shape(torn_sf) +
    tm_dots(col = "#FB6A4A", size = 0.2, shape = 1, fill_alpha = 0.5)
```

```{r}
torn_clip_sf <- torn_sf[AoI_sf,]

tm_shape(torn_clip_sf) +
  tm_dots(col = "#FB6A4A", size = 0.2, shape = 1, fill_alpha = 0.5) +
  tm_shape(AoI_sf) +
    tm_borders()
```

```{r}
# Points inside Texas
AoI_torn_m <- st_intersection(torn_m, AoI_m)

# Quick map
tmap_mode("plot")
tm_shape(AoI_m) + tm_polygons(alpha = 0.2) +
tm_shape(AoI_torn_m) + tm_symbols(size = 0.05)
```

```{r}
head(AoI_torn_m)

```

```{r}
# select an Area of Interest and apply a buffer
us_states2_sf <- st_as_sf(us_states2) 
AoI_sf <- st_as_sf(us_states2_sf[us_states2_sf$STATE_NAME %in% "Texas",])
```


```{r}
# Your turn 2 ---
```


```{r}
# 25 km (= 25,000 m) buffer
AoI_buf_m <- st_buffer(AoI_m, dist = 25000)

# Map buffer + Texas
tm_shape(AoI_buf_m) + tm_polygons(alpha = 0.15) +
tm_shape(AoI_m)     + tm_borders(lwd = 2)
```

```{r}
# Your turn 3 ---
```

```{r}
# Convert Georgia (from us_states) to sf & meters, then buffer 5 km
GA_sf <- us_states_sf %>% filter(STATE_NAME == "Georgia")
GA_m  <- st_transform(GA_sf, crs_m)
GA_buf_5km <- st_buffer(GA_m, dist = 5000)

tm_shape(GA_buf_5km) + tm_polygons(alpha = 0.15) +
tm_shape(GA_m)       + tm_borders(lwd = 2)
```

```{r}
us_states2_sf <- st_transform(us_states_sf, 5070)
AoI.merge_sf <- st_sf(st_union(us_states_sf))

tm_shape(us_states_sf) + tm_borders(col = "darkgreen", lty = 3) + 
  tm_shape(AoI.merge_sf) + tm_borders(lwd = 1.5, col = "black") + 
  tm_layout(frame = F)
```

```{r}
# Your turn 4 --- 

#st_union() returns only geometry (sfc). It drops the data frame.
#Wrap with st_sf() to make it a proper sf object again so you can map/join it.
```

```{r}
# Your turn 5 ---
```

```{r}
# start from your existing us_states_sf
us_states_m <- st_transform(us_states_sf, 5070)   # project to meters

# centroids
us_states_centroids <- st_centroid(us_states_m)

# quick map
tmap_mode("plot")
tm_shape(us_states_m) + tm_polygons(alpha = 0.2, border.col = "black") +
tm_shape(us_states_centroids) + tm_dots(size = 0.05)
```

```{r}
data(nz)
nz_pos <- st_point_on_surface(nz)
```

```{r}
qtm(nz) + qtm(nz_pos, col = "red")
```

```{r}
# Compare to st_centroid
nz_pos2 <- st_centroid(nz)
```

```{r}
qtm(nz) + qtm(nz_pos2, col = "blue") + qtm(nz_pos, col = "red")
```


```{r}
# create a matrix of 2 columns
m <- matrix(c(1, 3, 5, 1, 3, 1), ncol = 2) 
m
```

```{r}
# create multipoint data from this matrix
multipoint <- st_multipoint(m)
class(multipoint)
```

```{r}
linestring <- st_cast(multipoint, "LINESTRING")
class(linestring)
```

```{r}
polyg <- st_cast(multipoint, "POLYGON")
class(polyg)
```

```{r}
# Your turn 6 ----
```



```{r}
# create a simple matrix of points
m <- matrix(c(1,3,5, 1,3,1), ncol = 2)

# multipoint
mp  <- st_multipoint(m)

# cast to line and polygon
ln  <- st_cast(mp, "LINESTRING")
ply <- st_cast(mp, "POLYGON")

# wrap as sf objects
mp_sf  <- st_sf(geometry = st_sfc(mp))
ln_sf  <- st_sf(geometry = st_sfc(ln))
ply_sf <- st_sf(geometry = st_sfc(ply))

# plot all three
tmap_mode("plot")
tm_shape(ply_sf) + tm_polygons(col = "grey80", border.col = "red") +
tm_shape(ln_sf)  + tm_lines(col = "red", lwd = 2) +
tm_shape(mp_sf)  + tm_dots(col = "blue", size = 0.15)
```

```{r}
multipoint_2 = st_cast(linestring, "MULTIPOINT")
multipoint_3 = st_cast(polyg, "MULTIPOINT")
# all.equal(multipoint, multipoint_2, multipoint_3)
```

```{r}
torn.count2 <- st_contains(us_states_sf, torn_sf, sparse = TRUE) 
torn.count2
```

```{r}
torn_by_state <- us_states_sf %>%
  mutate(torn.count = lengths(st_contains(us_states_sf, torn_sf)))
head(torn_by_state)
```


```{r}
head(torn_by_state$torn.count)
```

```{r}
crs_m <- 5070
torn_m <- st_transform(torn_sf, crs_m)
AoI_m  <- st_transform(AoI_sf,  crs_m)

# count tornado points that intersect Texas
tx_torn <- st_join(torn_m, AoI_m, join = st_intersects, left = FALSE)
n_tx <- nrow(tx_torn)
n_tx
```

```{r}
# Check  projection
st_crs(us_states2_sf) # NAD83 is in meters
```

```{r}
# Calculate area of each state in square metter
st_area(us_states2_sf)
```

```{r}
# Change to km2 (with 1km = 10^6 m2)
st_area(us_states2_sf)/1000000 
```

```{r}

```



